---
title: "final_project"
author: "Arielle Herman"
date: "4/4/2021"
output:
  html_document:
    keep_md: True
---

```{r setup, include=F}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(sf)
library(readxl)
```

```{r data, message=F, warning=F, include=F}
nypp <- st_read("data/police_precincts", layer = "nypp")
a <- read_csv("data/allegations_202007271729.csv")
rank <- read_xlsx("data/CCRBDataLayoutTable.xlsx", sheet = 2)
rank
ny_pop <- read_csv("data/nyc_2010pop_2020precincts.csv")
ny_pop
```

# Data Exploration

## Overall Questions

1.  Which precinct has the most allegations?
2.  What are the characteristics of that precinct? (socioeconomically?)
3.  What is the average age of the complainant in which precincts?
4.  What is the average gender?
5.  What is the change in rank?
6.  Did the allegation happen in their command precinct?
7.  Have the number of complaints increased over time?
8.  Does it happen mostly with the same complainant?
9. Are certain allegations associated with higher substantiation rates?
10. How many allegations are frequently levied in the same complaint?

## What are the consequences of Allegations?

1.  How many are there?
2.  Does the amount change over time?
3.  Does it vary by the demographics of the complainaint ot the location of the complaint?
4.  What happens to officers as they continue to get allegations?

Another way to look at presence of reactions to repeat offenses could be the change in command or precinct.

### Repeat Offenses

First, let's take a look at the distribution of repeat allegations. In the below histogram, we can see that 50% of officers in this dataset have about 13 or fewer allegations (but that's a lot!). Also, some officers, have as many as 70 allegations against them!  But this dataset goes back until the 1980s and contains data only on current officers, and these data points concern officers who are still on the force and have had more time to collect allegations.  So, we can divide up the officers by "year of entry" (defined as the first registered year of a substantiated allegation) to compare officers who have had similar numbers of years to collect allegations.

In order to be included in the dataset, officers must have at least one substantiated allegation against them. We can see in the below plots that, indeed, for officers with only one allegation, it was substantiated. I would expect that as officers continue to recieve allegations, there would be an increasing rate of substantiation, however, it appears to peter off. These patterns do not appear to vary by the race of the complainant (coded as white or other), although it does appear that nonwhite complainants compose a majority in this dataset.

Skews proportion toward substantiated for officers with fewer allegations

```{r echo=F}
base <- a %>% group_by(unique_mos_id) %>% mutate(repeats = n()) %>%
  mutate(mos_eth = ifelse(mos_ethnicity == "White", "White", "Other"), complainant_eth = ifelse(complainant_ethnicity == "White", "White", "Other")) %>%
  ggplot(aes(x = repeats, group = word(board_disposition, 1), fill = word(board_disposition, 1))) +
  ggtitle("Officers by Number of Repeat Allegations") +
  xlab("Number of Allegations per Officer") +
  ggthemes::theme_tufte() +
  labs(fill = "Board Disposition")

names <- c("Non-White", "White", "Unknown")

base + geom_bar() + geom_vline(aes(xintercept = median(repeats))) + ylab("Number of Officers")

a %>% mutate(decade_received = floor(year_received/10)*10) %>%
  group_by(unique_mos_id) %>% mutate(decade_first = min(decade_received)) %>%
  group_by(decade_first, unique_mos_id) %>% mutate(repeats = n()) %>%
  #filter(decade != 2020) %>%
  ggplot(aes(x = repeats, fill = word(board_disposition, 1))) + geom_bar() + facet_grid(decade_first ~ .) +
  ggtitle("Total Allegations against Officers by Decade of first Allegation") +
  theme(panel.grid = element_blank()) + labs(fill = "Board Disposition") + ylab("Number of Officers") + xlab("Number of Allegations per Officer")

# make race labels more visible
a %>% group_by(unique_mos_id) %>% mutate(incident = row_number()) %>% filter(max(incident) > 70) %>% select(last_name, year_received, incident) 

base + geom_bar() + geom_vline(aes(xintercept = median(repeats))) + ylab("Number of Officers") +
  facet_wrap(. ~ complainant_eth) + ggtitle("Officers by Number of Repeat Allegations\nby Complainant Ethnicity")

# thin out axis labels
base + geom_bar(position = "fill") + ylab(NULL) +
  facet_wrap(. ~ complainant_eth) + ggtitle("Allegation Outcome by Number of Repeat Allegations per Officer and Complainant Ethnicity")
```

### Rank Changes: associating the conclusion of the civilian complaint review board with changes in rank of officer.

1. Do the proportions change the greater the number of allegations levied against an officer? (maybe a scatter plot?) x = incidents, y = proportion allegations associated with a demotion
2. How many allegations does it take for an officer to be demoted?
3. What is the change in rank over time?
4. How many officers have been demoted after a substantiated claim?
5. what is the breakdown in race of substantiated claims?
6. who are the people who are demoted and when along their career?  How many allegations does it take before a demotion?

First, let's take a look at the rates of substantiated claims over time.  It appears that, as time has passed, there have been an increase in number of substantiated and exonerated claims.  More than anything else, this likely reflects increasing investigation ability and improved data storage.  But, we can see that in the early 2000s, a higher proportion of allegations were exonerated than substantiated, and this differential has lessened in recent years.

How is this impacted by admittance of officers into the dataset.
Likely officers who had lots of substantiated claims from way back when have been fired (and so are no longer represented).
More and more new officers who have had only one substantiated complaint.
How to control for the missingness of the data.
We can't conclude anything from overall trends, but these bumps suggest that something interesting happened there.  Missingness of data doesn't explain the bumps (political climate).

```{r message=FALSE}
a %>% group_by(board_disposition = word(board_disposition, 1)) %>% filter(year_received < 2020) %>%
  ggplot(aes(x = year_received,
             fill = factor(board_disposition,
                           levels = c("Exonerated", "Unsubstantiated", "Substantiated")))) +
  geom_bar(position = "fill") + labs(fill = "Board Disposition")  +
  ggthemes::theme_tufte() +
  scale_fill_manual("", values = c("#6666FF", "#CCCCFF", "red")) +
  ggtitle("Proportion of Allegation Results Over Time") + xlab("Year Received") + ylab("Proportion")


# using reshaped from below
reshaped %>% ggplot(aes(x = year_received, fill = factor(board_disposition, levels = c("Exonerated", "Unsubstantiated", "Substantiated")))) + geom_bar(position = "fill") +
  scale_fill_manual("", values = c("#6666FF", "#CCCCFF", "red"))
```

Next, we might be able to see consequences for behavioral misconduct in terms of changes in rank.  We may see that certain conclusions of the civilian complaint review board on a given allegation are associated with an increase or decrease in rank of the officer.

In order to do this, I rated the ranks numerically as visible in the below table.

```{r rank_dict, echo=F, include=FALSE}
## confirm that ranks and abbreviations make sense at time of incident...
a %>% left_join(rank, by = c("rank_abbrev_incident" = "Abbreviation")) %>% group_by(rank_incident) %>%
  summarize(ranks = paste(unique(Rank), collapse = ", "))
## and now:
a %>% left_join(rank, by = c("rank_abbrev_now" = "Abbreviation")) %>% group_by(rank_now) %>%
  summarize(ranks = paste(unique(Rank), collapse = ", "))
## code numbers for ranks
rank$Rank <- str_to_lower(rank$Rank)
rank_dict <- rank %>%
  # record the order of the categories
  mutate(row = row_number()) %>%
  # filter for relevant categories
  filter(Abbreviation %in% c(unique(a$rank_abbrev_incident, a$rank_abbrev_now))) %>%
  # regroup through string matching
  group_by(rank_cat = case_when(
    str_detect(Rank, "chief") ~ "chiefs and other ranks",
    str_detect(Rank, "deputy|police") ~ Rank,
    TRUE ~ word(Rank, 1))) %>%
  # select only first item in each new category
  transmute(rank = row_number()) %>% filter(rank == 1) %>%
  # record rank
  ungroup() %>% mutate(rank = row_number())
```

```{r join_rank, echo=F}
rank_dict

# str_to_lower
cols <- c("rank_incident", "rank_now")
a[cols] <- sapply(a[cols], str_to_lower)

# do they always get closed at the same time?
## all complaints are resolved at the same time
a %>% group_by(complaint_id, date = zoo::as.yearmon(paste(year_closed, month_closed, sep = "-"))) %>% summarize(count = n()) %>% group_by(complaint_id) %>% summarize(count = n()) %>% group_by(count) %>% summarize(test = n())

# what should take precedence (substantiated, unsubstantiated, exonerated)
## I am not looking at the severity of the allegation.
## is it a problem that two complaints are lodged and resolved in the same year?  look at the most severe of those outcomes?
#rank_now <- as.data.frame()...

reshaped <- a %>% mutate(date_r = zoo::as.yearmon(paste(year_received, month_received, sep = "-")), date_c = zoo::as.yearmon(paste(year_closed, month_closed, sep = "-"))) %>%
  left_join(rank_dict, by = c("rank_incident" = "rank_cat")) %>% rename(rank_incident_no = rank) %>%
  left_join(rank_dict, by = c("rank_now" = "rank_cat")) %>% rename(rank_now_no = rank) %>%
  filter(unique_mos_id %in% c(25814, 18589, 25861)) %>%
  mutate(board_disposition = factor(word(board_disposition, 1), levels = c("Substantiated", "Exonerated", "Unsubstantiated"))) %>%
  group_by(unique_mos_id, complaint_id) %>%
  arrange(board_disposition) %>% mutate(row = row_number()) %>% filter(row == 1) %>%
  group_by(unique_mos_id) %>% arrange(date_r) %>%
  mutate(complaint = row_number(), final = ifelse(complaint == max(complaint), 1, 0))
# rank_change = ifelse(final == 1, rank_now_no - rank_incident_no, diff(rank_incident_no))
reshaped

reshaped$rank_closed_no <- 0
reshaped$rank_date_check <- zoo::as.yearmon("1000-01")
for (i in 1:nrow(reshaped)) {
 if (reshaped$date_c[i] == reshaped$date_r[i]) {
    reshaped$rank_closed_no[i] <- reshaped$rank_incident_no[i]
    reshaped$rank_date_check[i] <- reshaped$date_r[i]
  } else {
    value <- max(reshaped$date_r[which(reshaped$date_c[i] > reshaped$date_r)])
    index <- last(which(reshaped$date_r == value))
    reshaped$rank_closed_no[i] <- reshaped$rank_incident_no[index]
    reshaped$rank_date_check[i] <- zoo::as.yearmon(reshaped$date_r[index])
  }
}
cols <- c("final", "rank_incident_no", "rank_now_no", "date_r", "rank_closed_no", "date_c", "rank_closed_no", "rank_date_check")
reshaped %>% select(cols) %>% arrange(unique_mos_id, date_c) %>%
  mutate(rank_change = ifelse(final == 1, rank_now_no - rank_incident_no, diff(rank_incident_no)),
         result = case_when(rank_change < 0 ~ "demoted",
                            rank_change == 0 ~ "unchanged",
                            rank_change > 0 ~ "promoted"),
         rank_diff_scale = ifelse(final == 0, rank_incident_no - first(rank_incident_no),
                                  rank_now_no - rank_incident_no))
# complaint as a whole, and categorize if any allegation associated with the complaint is substantiated, or exonerated

a_dict <- a %>% left_join(rank_dict, by = c("rank_incident" = "rank_cat")) %>% rename(rank_incident_no = rank) %>%
  left_join(rank_dict, by = c("rank_now" = "rank_cat")) %>% rename(rank_now_no = rank) %>%
  group_by(unique_mos_id) %>% mutate(rank_incident_no, incident = row_number(),
                                     final = ifelse(incident == max(incident), 1, 0),
                                     # only use this to code result
                                     rank_change = ifelse(final == 1,
                                                          rank_now_no - rank_incident_no, diff(rank_incident_no)),
                                     rank_diff_scale = ifelse(final == 0,
                                                        rank_incident_no - first(rank_incident_no),
                                                        rank_now_no - rank_incident_no),
                                     result = case_when(rank_change < 0 ~ "demoted",
                                                         rank_change == 0 ~ "unchanged",
                                                         rank_change > 0 ~ "promoted")) %>% ungroup()
```

```{r include=FALSE}
# test that this worked by looking at officers whose final allegation in the dataset reflects different rankings at time of incident and now
# number of officers in the database
total <- a_dict %>% select(unique_mos_id) %>% unique() %>% nrow()
rank_same <- a_dict %>% select(unique_mos_id, contains("rank")) %>%
  group_by(unique_mos_id) %>% mutate(incident = row_number(),
                                     final = ifelse(incident == max(incident), 1, 0)) %>%
  filter(final == 1) %>% filter(rank_diff_scale == 0) %>% nrow()
rank_diff <- a_dict %>% select(unique_mos_id, contains("rank")) %>%
  group_by(unique_mos_id) %>% mutate(incident = row_number(),
                                     final = ifelse(incident == max(incident), 1, 0)) %>%
  filter(final == 1) %>% filter(rank_diff_scale != 0) %>% nrow()
rank_same + rank_diff == total

rbind(rank_same, rank_diff) %>% cbind(
# confirm that nobody with different ranks on the final allegation was categorized as no change on their final allegation
a_dict %>% filter(final == 1) %>% 
  group_by(is_final = final == 1, no_change = rank_incident_no == rank_now_no,
                    rank_diff_is_zero = rank_diff == 0) %>% summarize(count = n()))
```

```{r eval=FALSE, include=FALSE}
length(unique(a$unique_mos_id))

cols <- c("unique_mos_id", "rank_incident_no", "rank_now_no", "rank_diff", "incident", "diff", "test")



a %>% filter(rank_incident != rank_now)
a_dict %>% group_by(unique_mos_id) %>% mutate(incident = row_number(),
                                              final = ifelse(incident == max(incident), 1, 0)) %>%
  #filter(unique_mos_id == 18731) %>%
  filter(max(incident) > 60) %>%
  mutate(diff = ifelse(incident == 1, 0, diff(rank_incident_no)), test = cumsum(diff)) %>% .[cols]
  ggplot(aes(x = incident, y = cumsum(rank_diff), group = unique_mos_id, color = unique_mos_id)) + geom_jitter() + geom_smooth(se = FALSE) 
  
  
a_dict %>% group_by(unique_mos_id) %>% mutate(incident = row_number()) %>% mutate(test = rank_incident_no - min(rank_incident_no))
  ggplot(aes(x = incident, y = rank_incident_no)) + geom_jitter()
```

Although we can see that most allegations go unsubstantiated, the proportions across these results are relatively equivalent.  Further, the clear majority of officer ranks remain unchanged after a given allegation, such that it is difficult to compare or identify patterns in promotion and demotion rates of officers.

```{r warning=F, message=F, echo=F}
# note: allegations are grouped by complaint, and if an officer was promoted, this is only noted once per allegation

a_dict %>% #filter(incident == nth(incident, 3)) %>% don't know how to fitler for just the first one...
  group_by(board_disposition = word(board_disposition, 1), result) %>%
  summarize(count = n()) %>%
  group_by(board_disposition) %>% mutate(total = sum(count)) %>% ungroup() %>% mutate(width = round(total/sum(count), digits = 4)) %>%
  ggplot(aes(x = reorder(board_disposition, -count), y = count,
             fill = factor(result, levels = c( "promoted", "unchanged", "demoted")))) +
  geom_col(aes(width = width*1.2), position = "fill") +
  
  ggthemes::theme_tufte() +
  ggtitle("Change in Officer Rank after an Allegation by Outcome") + xlab(NULL) + ylab(NULL) +
  theme(legend.title = element_blank(), legend.position =  "bottom",
        axis.ticks.y = element_blank(), axis.text.y = element_blank()) +
  geom_label(aes(label = paste0(factor(round(count/total*100, digits = 2)),"%")), position = position_fill(vjust = 0.5),
            size = 3) +
  #annotate("text", x = c("Unsubstantiated"), y = c(1.1), family="serif", size=3, 
  #         color="black", label = paste(max(a_reshape$total), "allegations")) +
  #annotate("text", x = c("Substantiated"), y = c(1.1), family="serif", size=3, 
  #         color="black", label = paste(min(a_reshape$total), "allegations")) +
  #annotate("text", x = c("Exonerated"), y = c(1.1), family="serif", size=3, 
  #         color="black", label = paste(median(a_reshape$total), "allegations")) +
  scale_fill_manual("", values = c("#6666FF", "#CCCCFF", "red"))



reshaped %>% group_by(board_disposition, result)
```

```{r}
a_dict %>%
  group_by(board_disposition = word(board_disposition, 1), complainant_ethnicity = case_when(
      complainant_ethnicity %in% c("White", "Black") ~ complainant_ethnicity,
      complainant_ethnicity %in% c("Unknown", "Refused") | is.na(complainant_ethnicity) ~ "Unknown",
      TRUE ~ "People of Color"
    )) %>% #summarize(count = n()) %>%
  ggplot(aes(x = board_disposition, group = result, fill = result)) + geom_bar(position = "fill") + facet_wrap(. ~ complainant_ethnicity) +
  theme(axis.text.x = element_text(angle = 60, vjust = 0.9, hjust = 1)) +
  ggtitle("race of complainant in allegations that result in a demotion")
```
```{r}
# race of officer in allegations that result in a demotion
a_dict %>%
  group_by(board_disposition = word(board_disposition, 1), result = factor(result, levels = c("demoted", "unchanged", "promoted")), mos_ethnicity = case_when(
      mos_ethnicity %in% c("White", "Black") ~ mos_ethnicity,
      mos_ethnicity %in% c("Unknown", "Refused") | is.na(mos_ethnicity) ~ "Unknown",
      TRUE ~ "People of Color"
    )) %>% summarize(count = n()) %>% group_by(mos_ethnicity, board_disposition) %>% mutate(total = sum(count)) %>%
  # plot
  ggplot(aes(x = board_disposition, y = count,
             fill = result)) + geom_col(position = "fill") + facet_wrap(. ~ mos_ethnicity) +
  theme(axis.text.x = element_text(angle = 60, vjust = 0.9, hjust = 1)) +
   geom_label(aes(label = paste0(factor(round(count/total*100, digits = 2)),"%"), size = 2), position = position_fill(vjust = 0.5),
            size = 3)
```

question: Important to mention duration here... (when is the case closed?)

Next, we can look at the change of officer ranks over time.  First, we can look at the relationship between proportion of officers demoted as more allegations are levied against them.  We can see in this first plot that, a higher percentage of allegations are associated with an officer's demotion after the 60th allegation.

However, it is important to remember that few officers make it to 60. In the next plot, we the shading of the colors indicates the relative proportions of allegations for each x-axis unit.  This demonstrates again that the majority of officers don't a dozen or so allegations.

Now, we can take a look at the change in rank over time of those officers with 60 or more allegations levied against them and have been demoted at least once throughout their careers.  We can see that many of them have had interesting, if not tumultuous careers.  I would not have expected there to be so many changes in the trajectory of ranks.  It could be that officers without allegations of misconduct have a more stable career trajectory, but we don't have data on that.  Demotions don't visually appear to be related to reaching a specific number of allegations, and are peppered throughout each of these officers' careers.  Also, of note, is that each of these officers end up at least as high in rank as they started.

Other important variables to consider in the future include the time between lodged allegations and the conclusion type of the civilian complaint review board as the number of allegations increase.

```{r message=F, echo=F}
a_dict %>% ggplot(aes(x = incident, fill = result)) + geom_histogram(position = "fill") +
  ggthemes::theme_tufte() + geom_vline(aes(xintercept = 20), color = "white") +
  geom_vline(aes(xintercept = 40), color = "white") + geom_vline(aes(xintercept = 60), color = "white") +
  ggtitle("Percentage Breakdown of Rank Change\nat an Officer's Nth Allegation") + ylab("Rank Change at Nth Allegation") +
  xlab("Allegation Number")

a_dict %>% group_by(result, incident) %>% summarize(count = n()) %>% group_by(incident) %>% mutate(total = sum(count)) %>%
  ungroup() %>% mutate(alpha = total/sum(count)) %>% arrange(desc(incident)) %>%
  ggplot(aes(x = incident, y = count, fill = result, alpha = alpha)) + geom_col(position = "fill") +
  ggthemes::theme_tufte() + geom_vline(aes(xintercept = 20), color = "white") +
  geom_vline(aes(xintercept = 40), color = "white") + geom_vline(aes(xintercept = 60), color = "white") +
  ggtitle("Precentage Breakdown of Rank Change\nat an Officer's Nth Allegation\n") +
  xlab("Allegation Number") + ylab("Rank Change at Nth Allegation") + labs(fill = "Rank\nChange",
                                                                           alpha = "Proportion\nCases\nOverall")


# https://stackoverflow.com/questions/27135962/how-to-fill-geom-polygon-with-different-colors-above-and-below-y-0
a_dict %>% group_by(unique_mos_id) %>% filter(min(rank_change) < 0, max(incident) >= 60) %>%
  #mutate(cat = x >= 0) %>%
  ggplot(aes(x = incident, y = rank_diff_scale)) +
  geom_area(alpha = 0.3) + 
  #geom_col(aes(fill = col)) +
  geom_hline(aes(yintercept = 0), color = "red", alpha = 0.5, lty = "dotted") +
  geom_line() +
  facet_grid(reorder(unique_mos_id, incident) ~ ., scales = "free_y", switch = "y") +
  #ggthemes::theme_tufte() +
  theme(axis.title.x=element_blank(), axis.text.y = element_blank(),
        strip.text.y.left = element_text(angle = 0),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  ggtitle("Change in Officer Rank after each Allegation of Misconduct") +
  #ylab("#ID of Officers with 1+ demotion(s) and 60+ allegations") +
  geom_vline(aes(xintercept = 60), color = "white", size = 1.5) +
  ylab("Relative Rank Change") + xlab("Allegation Number")
```

## Allegation Location

1. Where do allegations occur?
2. Do they occur in the same precinct that the office is assigned to?
3. Does it take longer to resolve allegations in some areas versus others?
4. duration between opening and closing

The median response time to allegations is just over half a year.

Finally, we can take a look at where the allegations occur.

### Most Frequent Allegation Location

```{r include=F}
library(rvest)
url <- "https://www1.nyc.gov/site/nypd/bureaus/patrol/precincts-landing.page"
page <- read_html(url)
buroughs <- c("Manhattan", "Bronx", "Brooklyn", "Queens", "Staten Island")
table <- page %>% html_nodes("table") %>% html_table(fill=TRUE) %>% as.data.frame()
rows <- seq(1, nrow(table))
index <- c(rows[table$Precinct %in% buroughs], nrow(table)+1)
out <- c()
for (i in 1:5) {
  len <- index[i+1] - index[i]
  temp <- replicate(len, buroughs[i])
  #temp <- c(index[1], temp)
  out <- c(out, temp)
  #out <- rbind(out, temp)
}
unique(a$precinct)
table <- cbind(table, as_tibble(out)) %>% rename(burough = value)
pb <- table %>% filter(Precinct != burough) %>% mutate(precinct = str_extract(Precinct, "(\\d)+")) %>%
  mutate(precinct = case_when(
    !is.na(precinct) ~ precinct,
    Precinct == "Midtown South Precinct" ~ "14",
    Precinct == "Midtown North Precinct" ~ "18",
    Precinct == "Central Park Precinct" ~ "22"
  )) %>% mutate(precinct = as.integer(precinct))

a %>% filter(year_received > 2010) %>%
  group_by(precinct) %>% summarize(count = n()) %>%
  left_join(ny_pop, by = c("precinct" = "precinct_2020")) %>% left_join(pb, by = c("precinct" = "precinct")) %>%
  ggplot(aes(x = precinct, y = count, color = burough, size = P0010001/1000, alpha = 0.5)) + geom_point()
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
# only look at the past five years to account for careers ending
# don't have a variable for when the incident occurred?
#sub <- a["year_received" > 2015, ]
#sub$month_received <- ifelse(length(sub$month_received == 1), paste0("0", sub$month_received), sub$month_received)
#sub$date <- as.yearmon(paste(sub$year_received, sub$month_received, sep = "-"))

# perhaps later look at the frequency of complaints?
summarize(group_by(filter(a, year_received > 2015), precinct), count = n()) %>% mutate(total = sum(count))
left_join(nypp, summarize(group_by(filter(a, year_received > 2010), precinct), count = n()),
          by = c("Precinct" = "precinct")) %>%
  left_join(ny_pop[c("precinct_2020", "P0010001")], by = c("Precinct" = "precinct_2020")) %>%
  ggplot() + geom_sf(aes(fill = count), color = "white") + ggthemes::theme_tufte() +
  scale_fill_continuous(type = "viridis", direction = -1) +
  ggtitle("Frequency of Allegations by Precinct (year > 2015)") +
  geom_sf_text(aes(label = ifelse(count > 400, Precinct, "")), size = 3, color = "white") +
  theme(axis.title = element_blank())

# is there are higher substantiation or demotion rate per allegation in precinct 75?
a_dict %>% group_by(precinct = precinct == 75, board_disposition = word(board_disposition, 1)) %>% summarize(count = n()) %>% na.omit() %>% group_by(precinct) %>% mutate(prop = round(count/sum(count), digits = 4)*100) %>%
  ggplot(aes(x = precinct, y = count, fill = board_disposition)) + geom_col(position = "fill") +
  ggthemes::theme_tufte() + theme(axis.ticks.y = element_blank(), axis.text.y = element_blank()) +
  ggtitle("Board Disposition by Precinct") + labs(fill = "Board Disposition") + xlab("Precinct") +
  scale_x_discrete(limits=c("TRUE", "FALSE"), labels = c("Precinct 75", "Other Precincts")) +
  geom_text(aes(label = paste0(prop, "%")), position = position_fill(vjust = 0.5)) + ylab(NULL)

# is the command the same?
a_dict[grepl("PCT", a_dict$command_at_incident),] %>%
  mutate(pct = as.integer(str_extract(command_at_incident, "(\\d)+"))) %>%
  group_by(same = precinct == pct) %>% summarize(count = n())


# Median response time
a %>% filter(year_received > 2015) %>%
  mutate(date_r = zoo::as.yearmon(paste(year_received, month_received, sep = "-")),
         date_c = zoo::as.yearmon(paste(year_closed, month_closed, sep = "-")),
         # looks like a proportion of a year (ie .5 = 6 months)
         duration = (date_c - date_r)) %>% summarize(median = median(duration))

a_reshape <- a %>% filter(year_received > 2015) %>%
  mutate(date_r = zoo::as.yearmon(paste(year_received, month_received, sep = "-")),
         date_c = zoo::as.yearmon(paste(year_closed, month_closed, sep = "-")),
         # looks like a proportion of a year (ie .5 = 6 months)
         duration = (date_c - date_r)) %>% group_by(precinct) %>% summarize(mean = median(duration)*100)

nypp %>% left_join(a_reshape, by = c("Precinct" = "precinct")) %>%
  ggplot() + geom_sf(aes(fill = mean), color = "white") +
  ggthemes::theme_tufte() + theme(axis.title = element_blank()) +
  scale_fill_continuous(type = "viridis", direction = -1) +
  ggtitle("Median Response time to Allegations (Year > 2015)") +
  labs(fill = "Median Response\nTime (% of a yr)") +
  geom_sf_text(aes(label = ifelse(mean >= 85, Precinct, "")), size = 3, color = "white")

a_dict %>% group_by(precinct = precinct == 100, board_disposition = word(board_disposition, 1)) %>% summarize(count = n()) %>% na.omit() %>% group_by(precinct) %>% mutate(prop = round(count/sum(count), digits = 4)*100) %>%
  ggplot(aes(x = precinct, y = count, fill = board_disposition)) + geom_col(position = "fill") +
  ggthemes::theme_tufte() + theme(axis.ticks.y = element_blank(), axis.text.y = element_blank()) +
  ggtitle("Board Disposition by Precinct") + labs(fill = "Board Disposition") + xlab("Precinct") +
  scale_x_discrete(limits=c("TRUE", "FALSE"), labels = c("Precinct 100", "Other Precincts")) +
  geom_text(aes(label = paste0(prop, "%")), position = position_fill(vjust = 0.5)) + ylab(NULL)
  
  #theme(axis.ticks.x = element_text(labels = c("100", "Other")))

```
